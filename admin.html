<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Blog Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css"/>
  <script src="https://kit.fontawesome.com/397fc878e3.js" crossorigin="anonymous"></script>
  <!-- Firebase compat scripts (safer across environments) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    /* Ensure buttons show pointer cursor here, even if global CSS targets only anchors */
    .btn { cursor: pointer; }
  </style>
  <style>
    .admin-wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .admin-header { display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
    .admin-grid { display:grid; grid-template-columns: 360px 1fr; gap: 14px; }
    @media (max-width: 980px) { .admin-grid { grid-template-columns: 1fr; } }
    .panel { border: 1px solid var(--border); border-radius: 14px; background: var(--bg-soft); padding: 12px; }
    .list { display:flex; flex-direction: column; gap: 8px; max-height: 70vh; overflow:auto; }
    .post-item { display:flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px solid var(--border); border-radius: 12px; padding: 8px; background: rgba(255,255,255,.02); cursor: pointer; }
    .post-item:hover { outline: 1px solid rgba(124,58,237,.5); }
    .post-item h4 { margin: 0; font-size: 16px; }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-grid .full { grid-column: 1 / -1; }
    label { font-size: 12px; color: var(--muted); }
    input[type=text], input[type=date], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: rgba(255,255,255,.02); color: #eef2f7; }
    textarea { min-height: 160px; }
    .row { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .img-list { display:flex; gap:8px; flex-wrap: wrap; }
    .img-list img { width: 90px; height: 70px; object-fit: cover; border-radius: 10px; border:1px solid var(--border); }
    .muted-small { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <main class="admin-wrap">
    <div class="admin-header">
      <div>
        <div class="shell-crumbs"><span class="chip mono shell">~/</span><span class="chip mono shell">admin</span></div>
        <h1 style="margin:6px 0 4px;">Blog Manager</h1>
        <div class="muted">Secure admin to add/edit/delete posts</div>
        <div id="fb-status" class="muted" style="margin-top:6px; font-weight:500; color:#cfd4dc">Status: waiting for scripts…</div>
      </div>
      <div class="row">
        <button id="login" class="btn"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button>
        <button id="logout" class="btn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Sign out</button>
        <a class="btn" href="blog.html"><i class="fa-solid fa-arrow-up-right-from-square"></i> View Blog</a>
      </div>
    </div>

    <div class="panel" id="auth-guard" style="display:none">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <div class="row">
          <span class="chip mono" id="user-email">n/a</span>
          <span class="chip mono" id="user-uid">uid</span>
        </div>
        <div class="row">
          <button id="new-post" class="btn"><i class="fa-solid fa-plus"></i> New Post</button>
          <button id="export-json" class="btn"><i class="fa-solid fa-file-export"></i> Export JSON</button>
        </div>
      </div>
    </div>

    <div class="admin-grid" id="admin-ui" style="display:none">
      <div class="panel">
        <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 8px;">
          <h3 style="margin:0">Posts</h3>
          <small class="muted-small">Click a post to edit</small>
        </div>
        <div id="post-list" class="list" aria-live="polite" aria-busy="false"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">Editor</h3>
        <form id="post-form" class="form-grid">
          <input type="hidden" id="post-id" />
          <div>
            <label>Title</label>
            <input type="text" id="post-title" placeholder="Post title" required />
          </div>
          <div>
            <label>Date</label>
            <input type="date" id="post-date" />
          </div>
          <div>
            <label>Category</label>
            <input type="text" id="post-category" placeholder="e.g. CTF, Hackathon, Personal Project, Uni Assignment" />
          </div>
          <div>
            <label>Category Key</label>
            <input type="text" id="post-categoryKey" placeholder="ctf | hackathon | project | uni" />
          </div>
          <div class="full">
            <label>Tags</label>
            <div id="post-tags-selected" class="row" style="gap:6px; margin:6px 0 6px;"></div>
            <input type="text" id="post-tags-input" placeholder="Type a tag and press Enter…" />
            <small class="muted-small">Tip: click suggestions to add. Or press Enter to add a new tag. You can manage the library below.</small>
            <div class="row" style="justify-content: space-between; align-items:center; margin-top:6px;">
              <div id="post-tags-suggest" class="row" style="gap:6px;"></div>
              <button id="tags-promote" type="button" class="btn"><i class="fa-solid fa-plus"></i> Add selected to library</button>
            </div>
          </div>
          <div>
            <label>Category Icon (Font Awesome class)</label>
            <div class="row">
              <input type="text" id="post-icon" placeholder="fa-flag | fa-trophy | fa-code | fa-graduation-cap" />
              <button id="pick-post-icon" type="button" class="btn"><i class="fa-solid fa-icons"></i> Pick</button>
            </div>
          </div>
          <div class="full">
            <label>Summary</label>
            <textarea id="post-summary" placeholder="Short summary..."></textarea>
          </div>
          <div class="full">
            <label>Body (HTML)</label>
            <textarea id="post-bodyHtml" placeholder="Full post body in HTML"></textarea>
          </div>
          <div class="full">
            <label>Images</label>
            <div class="row" style="margin:6px 0">
              <input type="text" id="img-url" placeholder="Image URL" />
              <button id="add-img-url" class="btn" type="button"><i class="fa-solid fa-plus"></i> Add</button>
              <label class="btn" for="img-file"><i class="fa-solid fa-upload"></i> Upload</label>
              <input id="img-file" type="file" accept="image/*" style="display:none" />
            </div>
            <div id="img-list" class="img-list"></div>
          </div>
          <div class="full">
            <label>Links (label|href per line)</label>
            <textarea id="post-links" placeholder="GitHub|https://github.com/...\nDemo|https://..."></textarea>
          </div>
          <div class="row full" style="justify-content: space-between;">
            <div class="row">
              <button id="save-post" class="btn" type="submit"><i class="fa-solid fa-floppy-disk"></i> Save</button>
              <button id="delete-post" class="btn" type="button"><i class="fa-solid fa-trash"></i> Delete</button>
            </div>
            <small class="muted-small">Images upload requires Firebase Storage configured.</small>
          </div>
        </form>
      </div>
    </div>

    <div class="panel" id="setup-hint">
      <h3 style="margin:0 0 8px;">Setup Firebase</h3>
      <p class="muted">Add your Firebase config in <code>js/firebase-config.js</code> to enable secure login and Firestore-based storage.</p>
    </div>
  </main>

  <!-- Tag Library Management -->
  <div class="admin-wrap" id="admin-tags" style="display:none">
    <div class="panel">
      <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 8px;">
        <h3 style="margin:0">Tag Library</h3>
        <small class="muted-small">Add/edit/remove available tags and icons</small>
      </div>
      <div class="row" style="align-items:flex-start; gap:14px; flex-wrap:wrap;">
        <div style="flex:2 1 420px; min-width:320px;">
          <div id="tag-list" class="list" style="max-height: 40vh;" aria-live="polite" aria-busy="false"></div>
        </div>
        <div style="flex:1 1 320px; min-width:280px;" class="panel">
          <h4 style="margin:0 0 8px">Edit Tag</h4>
          <input type="hidden" id="tag-id" />
          <div style="margin-bottom:8px">
            <label>Name</label>
            <input type="text" id="tag-name" placeholder="e.g. CTF" />
          </div>
          <div style="margin-bottom:8px">
            <label>Icon (Font Awesome class)</label>
            <div class="row">
              <input type="text" id="tag-icon" placeholder="fa-flag (optional)" />
              <button id="pick-tag-icon" type="button" class="btn"><i class="fa-solid fa-icons"></i> Pick</button>
            </div>
          </div>
          <div class="row">
            <button id="tag-save" class="btn" type="button"><i class="fa-solid fa-floppy-disk"></i> Save Tag</button>
            <button id="tag-new" class="btn" type="button"><i class="fa-solid fa-plus"></i> New</button>
            <button id="tag-delete" class="btn" type="button"><i class="fa-solid fa-trash"></i> Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects Manager -->
  <div class="admin-wrap" id="admin-projects" style="display:none">
    <div class="panel">
      <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 8px;">
        <h3 style="margin:0">Projects</h3>
        <div class="row">
          <button id="proj-new" class="btn" type="button"><i class="fa-solid fa-plus"></i> New Project</button>
          <button id="export-projects" class="btn" type="button"><i class="fa-solid fa-file-export"></i> Export Projects JSON</button>
        </div>
      </div>
      <div class="admin-grid">
        <div class="panel">
          <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 8px;">
            <h4 style="margin:0">List</h4>
            <small class="muted-small">Click to edit</small>
          </div>
          <div id="proj-list" class="list" style="max-height: 60vh;"></div>
        </div>
        <div class="panel">
          <h4 style="margin:0 0 8px">Editor</h4>
          <form id="proj-form" class="form-grid">
            <input type="hidden" id="proj-id" />
            <div>
              <label>Title</label>
              <input type="text" id="proj-title" placeholder="Project title" required />
            </div>
            <div>
              <label>Icon (Font Awesome class)</label>
              <div class="row">
                <input type="text" id="proj-icon" placeholder="fa-code | fa-gamepad | ..." />
                <button id="pick-proj-icon" type="button" class="btn"><i class="fa-solid fa-icons"></i> Pick</button>
              </div>
            </div>
            <div class="full">
              <label>Tags</label>
              <div id="proj-tags-selected" class="row" style="gap:6px; margin:6px 0 6px;"></div>
              <input type="text" id="proj-tags-input" placeholder="Type a tag and press Enter…" />
              <div class="row" style="justify-content: space-between; align-items:center; margin-top:6px;">
                <div id="proj-tags-suggest" class="row" style="gap:6px;"></div>
                <button id="proj-tags-promote" type="button" class="btn"><i class="fa-solid fa-plus"></i> Add selected to library</button>
              </div>
            </div>
            <div class="full">
              <label>Summary</label>
              <textarea id="proj-summary" placeholder="Short summary..."></textarea>
            </div>
            <div class="full">
              <label>Body (HTML)</label>
              <textarea id="proj-bodyHtml" placeholder="Details, notes, usage..."></textarea>
            </div>
            <div class="full">
              <label>Images</label>
              <div class="row" style="margin:6px 0">
                <input type="text" id="proj-img-url" placeholder="Image URL" />
                <button id="proj-add-img-url" class="btn" type="button"><i class="fa-solid fa-plus"></i> Add</button>
                <label class="btn" for="proj-img-file"><i class="fa-solid fa-upload"></i> Upload</label>
                <input id="proj-img-file" type="file" accept="image/*" style="display:none" />
              </div>
              <div id="proj-img-list" class="img-list"></div>
            </div>
            <div class="full">
              <label>Links (label|href per line)</label>
              <textarea id="proj-links" placeholder="Demo|https://...\nGitHub|https://..."></textarea>
            </div>
            <div class="row full" style="justify-content: space-between;">
              <div class="row">
                <button id="proj-save" class="btn" type="submit"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                <button id="proj-delete" class="btn" type="button"><i class="fa-solid fa-trash"></i> Delete</button>
              </div>
              <small class="muted-small">Images upload requires Firebase Storage configured.</small>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Icon Picker Modal -->
  <div id="icon-picker" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal__panel" style="max-width:720px;">
      <button class="modal__close" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      <div class="modal__content">
        <div class="row" style="margin-bottom:10px; gap:8px; align-items:center;">
          <input type="text" id="icon-search" placeholder="Search icons (e.g. flag, code)" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,.02); color:#eef2f7;"/>
          <button id="icon-clear" class="btn" type="button"><i class="fa-solid fa-ban"></i> None</button>
        </div>
        <div id="icon-grid" style="display:grid; grid-template-columns: repeat(6,minmax(0,1fr)); gap:8px;">
          <!-- populated by admin.js -->
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (modular v9) -->
  <!-- Config must load before admin.js -->
  <script src="js/firebase-config.js"></script>
  <script src="admin.js"></script>
  <script>
    // If you see this text update, base HTML loaded. If the line above fails to load,
    // you should still see this message applied.
    (function(){
      var el = document.getElementById('fb-status');
      if (el && !el.textContent) el.textContent = 'Status: base page loaded';
      // After a short delay, if the module didn't mark readiness, show a helpful hint
      setTimeout(function(){
        if (!window.__admin_ready) {
          if (el) el.textContent = 'Status: admin.js did not load — check Network tab for admin.js and js/firebase-config.js (allow localhost, disable blockers), and reload.';
          // As a sanity check, wire a plain click to prove the button is clickable even without the module
          var btn = document.getElementById('login');
          if (btn) {
            btn.addEventListener('click', function(){
              if (el) el.textContent = 'Status: Click detected, but Firebase scripts/modules are not loaded.';
              alert('Admin scripts are not loading. See status line for tips.');
            }, { once: true });
          }
        }
      }, 800);
    })();
  </script>
</body>
</html>
